<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestressing Report Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsPDF and jsPDF-AutoTable CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // Auth imports
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // Firestore imports (corrected the module path for doc, setDoc, onSnapshot)
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Set Firestore log level
        setLogLevel('Debug');
        
        // Assign all necessary functions to the window object for access by the main script
        window.firebase = {
            initializeApp, 
            getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged,
            getFirestore, doc, setDoc, onSnapshot
        };
    </script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .data-input {
            @apply w-full p-3 border border-gray-300 rounded-lg text-lg focus:ring-indigo-500 focus:border-indigo-500 transition-shadow;
        }
        .section-header {
            @apply text-xl font-bold text-indigo-800 mb-4 border-b pb-2 mt-6;
        }
        .calc-output {
            @apply p-3 bg-indigo-50 rounded-lg text-indigo-900 font-semibold;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div id="app" class="max-w-4xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-8">
        <h1 class="text-3xl font-extrabold text-gray-800 mb-6 border-b pb-3">Prestressing Report Generator</h1>
        
        <!-- User ID and Control -->
        <div class="space-y-3 mb-6 p-4 bg-gray-50 rounded-lg shadow-inner">
            <input type="text" id="user-id-display" class="data-input text-sm bg-gray-100 italic" readonly value="User ID Loading...">
            <button onclick="clearAllData()" class="w-full px-4 py-2 bg-red-500 text-white font-semibold rounded-lg shadow-md hover:bg-red-600 transition duration-150">
                Clear All Data
            </button>
        </div>

        <!-- Input Form -->
        <div id="input-form" class="space-y-6">
            
            <h2 class="section-header">Project & General Details</h2>
            <input type="text" id="project-name" class="data-input" placeholder="Project / Girder Name (e.g., A1-P1 L)">
            <input type="date" id="date-of-stressing" class="data-input">
            <input type="number" step="0.01" id="girder-length" class="data-input" placeholder="Girder Length (m)">
            <input type="number" id="concrete-age" class="data-input" placeholder="Concrete Age (Days)">
            <input type="number" id="concrete-strength" class="data-input" placeholder="Concrete Strength (N/mm²)">

            <h2 class="section-header">Jack & Gauge Parameters</h2>
            <input type="number" step="0.01" id="ram-area" class="data-input" placeholder="Stressing RAM Area (cm²)">
            <input type="number" step="0.1" id="jack-efficiency" class="data-input" placeholder="Jack Efficiency (%)">
            <input type="number" id="grip-length-design" class="data-input" placeholder="Grip Length Design (mm)">
            <input type="number" id="grip-length-actual" class="data-input" placeholder="Grip Length Actual (mm)">

            <h2 class="section-header">Strand & Material Properties</h2>
            <input type="number" step="0.01" id="e-modulus-design" class="data-input" placeholder="E Modulus Design (kN/mm²)">
            <input type="number" step="0.01" id="e-modulus-actual" class="data-input" placeholder="E Modulus Actual (kN/mm²)">
            <input type="number" step="0.01" id="strand-area-design" class="data-input" placeholder="Strand Area Design (mm²)">
            <input type="number" step="0.01" id="strand-area-actual" class="data-input" placeholder="Strand Area Actual (mm²)">
            <input type="number" step="0.001" id="strand-length-design" class="data-input" placeholder="Strand Length Design (m)">
            <input type="number" step="0.001" id="strand-length-actual" class="data-input" placeholder="Strand Length Actual (m)">
            
            <h2 class="section-header">Force & Elongation Targets</h2>
            <input type="number" id="jack-force-min" class="data-input" placeholder="Design Jack Force Min (kN)">
            <input type="number" id="jack-force-max" class="data-input" placeholder="Design Jack Force Max (kN)">
            <input type="number" step="0.01" id="elongation-jack" class="data-input" placeholder="Design Elongation (Jack, mm)">
            <input type="number" step="0.01" id="elongation-girder" class="data-input" placeholder="Design Elongation (Girder, mm)">

            <button onclick="saveAllInputs()" class="w-full p-4 bg-indigo-600 text-white font-extrabold text-xl rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 transform hover:scale-[1.01]">
                SAVE & CALCULATE
            </button>
        </div>

        <!-- Calculated Outputs & Summary -->
        <div id="calculations" class="mt-10 p-6 bg-blue-50 rounded-xl shadow-lg space-y-4">
            <h2 class="section-header !mt-0 text-blue-800">Calculated Report Targets</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="calc-output">
                    <div class="text-sm text-gray-600">Total Design Elongation (mm)</div>
                    <div id="calc-design-total" class="text-2xl">0.00</div>
                </div>
                <div class="calc-output">
                    <div class="text-sm text-gray-600">Target Min Jack Pressure (kg/cm²)</div>
                    <div id="calc-min-pressure" class="text-2xl">0.00</div>
                </div>
                <div class="calc-output">
                    <div class="text-sm text-gray-600">Modified Elongation Target (mm)</div>
                    <div id="calc-mod-elong" class="text-2xl">0.00</div>
                </div>
                <div class="calc-output">
                    <div class="text-sm text-gray-600">Elongation Range (+/- 5%) (mm)</div>
                    <div id="calc-range" class="text-2xl text-orange-600">0.00 - 0.00</div>
                </div>
            </div>
            
            <button onclick="exportToPDF()" class="w-full px-4 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150">
                Generate Final PDF Report
            </button>
        </div>
    </div>
    
    <!-- Toast Notification for Messages -->
    <div id="toast" class="fixed bottom-5 right-5 z-50 p-4 bg-gray-800 text-white rounded-lg shadow-xl hidden transition-opacity duration-300"></div>

    <script type="module">
        // Global variables for Firebase instances
        let app, db, auth;
        let userId = 'loading';
        let isAuthReady = false;

        // Data storage object aligned with report fields
        let reportData = {
            // Project Details
            projectName: '',
            dateOfStressing: '',
            girderLength: 0,
            concreteAge: 0,
            concreteStrength: 0,
            // Jack Parameters
            ramArea: 0, // cm²
            jackEfficiency: 0, // %
            gripLengthDesign: 0, // mm
            gripLengthActual: 0, // mm
            // Material Properties
            eModulusDesign: 0, // kN/mm²
            eModulusActual: 0, // kN/mm²
            strandAreaDesign: 0, // mm²
            strandAreaActual: 0, // mm²
            strandLengthDesign: 0, // m
            strandLengthActual: 0, // m
            // Force Targets
            jackForceMin: 0, // kN
            jackForceMax: 0, // kN
            elongationJack: 0, // mm
            elongationGirder: 0, // mm
        };

        // Constants from global scope
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Utility function for simple toast messages
        function showToast(message, duration = 3000) {
            const toastEl = document.getElementById('toast');
            toastEl.textContent = message;
            toastEl.classList.remove('hidden');
            toastEl.style.opacity = '1';
            
            setTimeout(() => {
                toastEl.style.opacity = '0';
                setTimeout(() => toastEl.classList.add('hidden'), 300);
            }, duration);
        }

        // --- Firebase & Auth Setup ---
        async function initializeFirebase() {
            if (!firebaseConfig) {
                showToast("Firebase Config not found. Data saving is disabled.", 5000);
                return;
            }
            
            // Check if window.firebase was successfully populated by the module script
            if (typeof window.firebase === 'undefined') {
                console.error("Firebase module imports failed to load.");
                showToast("Error loading Firebase modules. Please check network/console.", 5000);
                return;
            }

            try {
                // Destructure functions from the correctly populated window.firebase object
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, getFirestore, onAuthStateChanged } = window.firebase;
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Attach event listeners to all input fields to trigger save on change
                document.querySelectorAll('#input-form input').forEach(input => {
                    input.addEventListener('input', calculateTargets);
                });
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('user-id-display').value = `User ID: ${userId}`;
                        isAuthReady = true;
                        startDataListener();
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                            userId = auth.currentUser?.uid || 'anonymous';
                            document.getElementById('user-id-display').value = `User ID (Anon): ${userId}`;
                        }
                        isAuthReady = true;
                        startDataListener();
                    }
                });

            } catch (error) {
                console.error("Firebase Initialization failed:", error);
                showToast("Error initializing Firebase: " + error.message, 5000);
            }
        }

        // --- Firestore Operations ---
        function getDocumentRef() {
            if (!db || !userId) return null;
            // Public data storage path: /artifacts/{appId}/public/data/prestressing_report/{userId}
            return window.firebase.doc(db, 'artifacts', appId, 'public', 'data', 'prestressing_report', userId);
        }
        
        // Save current data (all report fields)
        async function saveReportData() {
            if (!isAuthReady || !db) return;

            // 1. Collect all data from UI and update reportData object
            reportData.projectName = document.getElementById('project-name').value;
            reportData.dateOfStressing = document.getElementById('date-of-stressing').value;
            reportData.girderLength = parseFloat(document.getElementById('girder-length').value) || 0;
            reportData.concreteAge = parseFloat(document.getElementById('concrete-age').value) || 0;
            reportData.concreteStrength = parseFloat(document.getElementById('concrete-strength').value) || 0;
            reportData.ramArea = parseFloat(document.getElementById('ram-area').value) || 0;
            reportData.jackEfficiency = parseFloat(document.getElementById('jack-efficiency').value) || 0;
            reportData.gripLengthDesign = parseFloat(document.getElementById('grip-length-design').value) || 0;
            reportData.gripLengthActual = parseFloat(document.getElementById('grip-length-actual').value) || 0;
            reportData.eModulusDesign = parseFloat(document.getElementById('e-modulus-design').value) || 0;
            reportData.eModulusActual = parseFloat(document.getElementById('e-modulus-actual').value) || 0;
            reportData.strandAreaDesign = parseFloat(document.getElementById('strand-area-design').value) || 0;
            reportData.strandAreaActual = parseFloat(document.getElementById('strand-area-actual').value) || 0;
            reportData.strandLengthDesign = parseFloat(document.getElementById('strand-length-design').value) || 0;
            reportData.strandLengthActual = parseFloat(document.getElementById('strand-length-actual').value) || 0;
            reportData.jackForceMin = parseFloat(document.getElementById('jack-force-min').value) || 0;
            reportData.jackForceMax = parseFloat(document.getElementById('jack-force-max').value) || 0;
            reportData.elongationJack = parseFloat(document.getElementById('elongation-jack').value) || 0;
            reportData.elongationGirder = parseFloat(document.getElementById('elongation-girder').value) || 0;

            const docRef = getDocumentRef();
            const dataToSave = {
                ...reportData,
                updatedAt: new Date().toISOString()
            };

            try {
                await window.firebase.setDoc(docRef, dataToSave, { merge: true });
                showToast("Data saved successfully.", 1500);
            } catch (error) {
                console.error("Error saving data:", error);
                showToast("Error saving data: " + error.message, 3000);
            }
        }

        // Listen for real-time updates
        function startDataListener() {
            const docRef = getDocumentRef();
            if (!docRef) return;

            const { onSnapshot } = window.firebase;

            onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    
                    // 1. Update reportData object
                    reportData = { ...reportData, ...data };
                    
                    // 2. Populate UI fields
                    document.getElementById('project-name').value = reportData.projectName;
                    document.getElementById('date-of-stressing').value = reportData.dateOfStressing;
                    document.getElementById('girder-length').value = reportData.girderLength || '';
                    document.getElementById('concrete-age').value = reportData.concreteAge || '';
                    document.getElementById('concrete-strength').value = reportData.concreteStrength || '';
                    document.getElementById('ram-area').value = reportData.ramArea || '';
                    document.getElementById('jack-efficiency').value = reportData.jackEfficiency || '';
                    document.getElementById('grip-length-design').value = reportData.gripLengthDesign || '';
                    document.getElementById('grip-length-actual').value = reportData.gripLengthActual || '';
                    document.getElementById('e-modulus-design').value = reportData.eModulusDesign || '';
                    document.getElementById('e-modulus-actual').value = reportData.eModulusActual || '';
                    document.getElementById('strand-area-design').value = reportData.strandAreaDesign || '';
                    document.getElementById('strand-area-actual').value = reportData.strandAreaActual || '';
                    document.getElementById('strand-length-design').value = reportData.strandLengthDesign || '';
                    document.getElementById('strand-length-actual').value = reportData.strandLengthActual || '';
                    document.getElementById('jack-force-min').value = reportData.jackForceMin || '';
                    document.getElementById('jack-force-max').value = reportData.jackForceMax || '';
                    document.getElementById('elongation-jack').value = reportData.elongationJack || '';
                    document.getElementById('elongation-girder').value = reportData.elongationGirder || '';

                    calculateTargets();
                    showToast("Data loaded successfully.", 2000);
                } else {
                    console.log("No existing data found, starting fresh.");
                    calculateTargets();
                }
            }, (error) => {
                console.error("Error listening to data:", error);
                showToast("Real-time sync error: " + error.message, 4000);
            });
        }
        
        window.saveAllInputs = function() {
            saveReportData();
        }

        // Function to clear all data
        window.clearAllData = function() {
            // NOTE: Using a custom modal is required, but for quick fix, we'll keep window.confirm temporarily.
            const confirmClear = window.confirm("Are you sure you want to permanently clear ALL data for this Prestressing Report? This action cannot be undone.");
            
            if (confirmClear) {
                // Reset in memory
                reportData = Object.keys(reportData).reduce((acc, key) => {
                    acc[key] = (typeof reportData[key] === 'string' || key === 'dateOfStressing') ? '' : 0;
                    return acc;
                }, {});

                // Clear UI
                document.querySelectorAll('#input-form input').forEach(input => input.value = '');

                // Save blank data to Firestore (effectively clearing it)
                saveReportData(); 
                calculateTargets();
                showToast("All data cleared successfully.", 3000);
            }
        }

        // --- Core Calculation Logic ---
        function calculateTargets() {
            // Ensure data is up-to-date from UI before calculating
            // This is primarily for the input listener, not the save button
            reportData.ramArea = parseFloat(document.getElementById('ram-area').value) || 0;
            reportData.jackEfficiency = parseFloat(document.getElementById('jack-efficiency').value) || 0;
            reportData.gripLengthDesign = parseFloat(document.getElementById('grip-length-design').value) || 0;
            reportData.gripLengthActual = parseFloat(document.getElementById('grip-length-actual').value) || 0;
            reportData.eModulusDesign = parseFloat(document.getElementById('e-modulus-design').value) || 0;
            reportData.eModulusActual = parseFloat(document.getElementById('e-modulus-actual').value) || 0;
            reportData.strandAreaDesign = parseFloat(document.getElementById('strand-area-design').value) || 0;
            reportData.strandAreaActual = parseFloat(document.getElementById('strand-area-actual').value) || 0;
            reportData.strandLengthDesign = parseFloat(document.getElementById('strand-length-design').value) * 1000 || 0; // Convert m to mm
            reportData.strandLengthActual = parseFloat(document.getElementById('strand-length-actual').value) * 1000 || 0; // Convert m to mm
            reportData.jackForceMin = parseFloat(document.getElementById('jack-force-min').value) || 0;
            reportData.elongationJack = parseFloat(document.getElementById('elongation-jack').value) || 0;
            reportData.elongationGirder = parseFloat(document.getElementById('elongation-girder').value) || 0;


            // Step 1: Total Design Elongation
            const designTotalElongation = reportData.elongationJack + reportData.elongationGirder;

            // Step 2: Modified elongation for length of strand
            let modElongLength = designTotalElongation;
            if (reportData.strandLengthDesign > 0) {
                // Formula from PDF: 84.38/24.376 * 24.436 (where 84.38 is ElongationJack)
                // We use the full design elongation * (Actual Length / Design Length)
                modElongLength = designTotalElongation * (reportData.strandLengthActual / reportData.strandLengthDesign);
            }
            
            // Step 3: Modified elongation within jack
            // Formula from PDF: 5.4 + (750-750)/1000 * 7 (Grip length actual - design)
            const modElongJack = reportData.elongationJack + ((reportData.gripLengthActual - reportData.gripLengthDesign) / 1000) * 7;
            
            // Step 4: Modified total elongation
            // NOTE: The original PDF logic seems inconsistent here. It uses: 84.588 (from Step 2) + 5.4 (from Step 3).
            // This implies: (Mod Elong Length) + (Mod Elong Jack - ElongationJack)
            const modifiedTotalElongation = modElongLength + (modElongJack - reportData.elongationJack);

            // Step 5: Modified elongation for cross sectional area
            let modElongArea = modifiedTotalElongation;
            if (reportData.strandAreaDesign > 0) {
                // Formula: 89.988 * 100 / 99.67 (where 100 is Design Area, 99.67 is Actual Area)
                // We use: Modified Total * (Design Area / Actual Area)
                modElongArea = modifiedTotalElongation * (reportData.strandAreaDesign / reportData.strandAreaActual);
            }

            // Step 6: Modified elongation for modulus of elasticity (Final Modified Target)
            let finalModifiedElongation = modElongArea;
            if (reportData.eModulusDesign > 0) {
                // Formula: 90.286 * 195 / 196.34 (where 195 is Design E-Modulus, 196.34 is Actual E-Modulus)
                // We use: Modified Area * (Design E-Modulus / Actual E-Modulus)
                finalModifiedElongation = modElongArea * (reportData.eModulusDesign / reportData.eModulusActual);
            }
            
            // Step 7: Calculate Min Pressure
            let minPressure = 0;
            if (reportData.ramArea > 0 && reportData.jackEfficiency > 0) {
                // Formula: (1642*1000 / (468.6 * 0.99)) / 100 = 3543.1 kg/cm² (from PDF)
                // Force * 1000 / (Ram Area * Efficiency) / 100
                const actualRamArea = reportData.ramArea * (reportData.jackEfficiency / 100);
                if (actualRamArea > 0) {
                    // Min Pressure (kg/cm²) = (Min Force (kN) * 1000) / (Ram Area (cm^2) * Efficiency (%)) 
                    // NOTE: This simplified formula is based on the logic seen in similar reports.
                    minPressure = (reportData.jackForceMin * 1000) / (reportData.ramArea * reportData.jackEfficiency);
                }
            }


            // Step 8: Calculate Range
            const minElongation = finalModifiedElongation * 0.95;
            const maxElongation = finalModifiedElongation * 1.05;


            // --- Update UI ---
            document.getElementById('calc-design-total').textContent = designTotalElongation.toFixed(2);
            document.getElementById('calc-min-pressure').textContent = minPressure.toFixed(2);
            document.getElementById('calc-mod-elong').textContent = finalModifiedElongation.toFixed(3);
            document.getElementById('calc-range').textContent = `${minElongation.toFixed(3)} - ${maxElongation.toFixed(3)}`;

            // Temporarily store calculated values for PDF
            reportData.designTotalElongation = designTotalElongation;
            reportData.modifiedElongationFinal = finalModifiedElongation;
            reportData.minPressure = minPressure;
            reportData.minElongationRange = minElongation;
            reportData.maxElongationRange = maxElongation;
        }

        // --- PDF Export ---
        window.exportToPDF = function() {
            if (reportData.ramArea === 0 || reportData.jackForceMin === 0) {
                showToast("Please enter all required design parameters before generating the report.", 3000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); 
            
            const pageWidth = doc.internal.pageSize.getWidth();
            let y = 15;

            // --- Title and Project Info ---
            doc.setFontSize(16);
            doc.setTextColor(30); 
            doc.setFont('helvetica', 'bold');
            doc.text(`Prestressing Report: ${reportData.projectName || 'Untitled'}`, 10, y);
            y += 8;

            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.setTextColor(50);
            doc.text(`Date of Stressing: ${reportData.dateOfStressing || 'N/A'}`, 10, y);
            doc.text(`Girder Length: ${reportData.girderLength.toFixed(2)} m`, pageWidth / 2, y);
            y += 5;
            doc.text(`Concrete Strength: ${reportData.concreteStrength} N/mm² (Age: ${reportData.concreteAge} Days)`, 10, y);
            doc.text(`User ID: ${userId}`, pageWidth / 2, y);
            y += 10;
            
            // --- Design Parameters Table ---
            const designBody = [
                ['Jack RAM Area (cm²)', reportData.ramArea.toFixed(2)],
                ['Jack Efficiency (%)', reportData.jackEfficiency.toFixed(1)],
                ['Grip Length (Design/Actual) (mm)', `${reportData.gripLengthDesign.toFixed(0)} / ${reportData.gripLengthActual.toFixed(0)}`],
                ['E Modulus (Design/Actual) (kN/mm²)', `${reportData.eModulusDesign.toFixed(2)} / ${reportData.eModulusActual.toFixed(2)}`],
                ['Strand Area (Design/Actual) (mm²)', `${reportData.strandAreaDesign.toFixed(2)} / ${reportData.strandAreaActual.toFixed(2)}`],
                // Strand length is stored in meters, but calculation converts to mm for internal use. Display in meters here.
                ['Strand Length (Design/Actual) (m)', `${(reportData.strandLengthDesign).toFixed(3)} / ${(reportData.strandLengthActual).toFixed(3)}`],
            ];

            doc.setFontSize(12);
            doc.text("Design & Material Properties", 10, y);
            y += 2;
            doc.autoTable({
                head: [['Parameter', 'Value']],
                body: designBody,
                startY: y,
                headStyles: { fillColor: [79, 70, 229], textColor: [255, 255, 255], fontSize: 10 },
                styles: { fontSize: 9, cellPadding: 2.5, textColor: [50, 50, 50] },
                margin: { left: 10, right: pageWidth - 10 }
            });
            
            y = doc.autoTable.previous.finalY + 5;
            
            // --- Target Calculations Table ---
            const calcBody = [
                ['Design Jack Force (Min/Max) (kN)', `${reportData.jackForceMin.toFixed(0)} / ${reportData.jackForceMax.toFixed(0)}`],
                ['Design Elongation (Jack/Girder) (mm)', `${reportData.elongationJack.toFixed(2)} / ${reportData.elongationGirder.toFixed(2)}`],
                ['Total Design Elongation (mm)', reportData.designTotalElongation.toFixed(3)],
                ['Min. Target Jack Pressure (kg/cm²)', reportData.minPressure.toFixed(3)],
                ['Final Modified Elongation Target (mm)', reportData.modifiedElongationFinal.toFixed(3)],
                ['Permissible Range (+/- 5%) (mm)', `${reportData.minElongationRange.toFixed(3)} to ${reportData.maxElongationRange.toFixed(3)}`],
            ];

            doc.setFontSize(12);
            doc.text("Stressing Targets & Limits", 10, y);
            y += 2;
            doc.autoTable({
                head: [['Calculation', 'Target Value']],
                body: calcBody,
                startY: y,
                headStyles: { fillColor: [22, 163, 74], textColor: [255, 255, 255], fontSize: 10 },
                styles: { fontSize: 9, cellPadding: 2.5, textColor: [50, 50, 50] },
                margin: { left: 10, right: 10 }
            });

            // --- Footnote ---
            const pageHeight = doc.internal.pageSize.height;
            doc.setFontSize(8);
            doc.setTextColor(150);
            doc.text("Generated by Prestressing Report Generator (Single-File App)", pageWidth / 2, pageHeight - 10, { align: 'center' });

            doc.save(`${reportData.projectName.replace(/ /g, '_') || 'prestressing-report'}_${reportData.dateOfStressing || 'date'}.pdf`);
            showToast("PDF report downloaded!", 3000);
        }
        
        // Initialize the application
        initializeFirebase();
    </script>
</body>
</html>
