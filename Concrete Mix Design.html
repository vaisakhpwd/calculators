<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IS 10262:2019 Concrete Mix Design</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for better readability and structure */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .container {
            max-width: 1200px;
        }
        .input-group label {
            font-weight: 500;
        }
        .input-field {
            border: 1px solid #d1d5db;
            padding: 10px;
            border-radius: 0.5rem;
            width: 100%;
            transition: all 0.2s;
        }
        .input-field:focus {
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.4);
            outline: none;
        }
        #output-card {
            min-height: 200px;
        }
        .calculation-step {
            background-color: #fff;
            padding: 1rem;
            border-radius: 0.5rem;
            border-left: 4px solid #34d399;
            margin-top: 10px;
        }
        .calculation-step h4 {
            font-weight: 600;
            color: #10b981;
            margin-bottom: 5px;
        }
        .calculation-step p {
            font-size: 0.875rem;
            color: #4b5563;
        }
        .calculation-step span.res {
            font-weight: bold;
            color: #1f2937;
        }
    </style>
</head>
<body class="p-4 md:p-8 bg-gray-50">

    <div class="container mx-auto bg-white shadow-xl rounded-xl p-6 md:p-10">
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl md:text-4xl font-extrabold text-gray-800">Concrete Mix Design (IS 10262:2019)</h1>
            <p class="mt-2 text-lg text-gray-600">Calculate material proportions (kg/m³) for 1 cubic meter of concrete.</p>
        </header>

        <main class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <section class="lg:col-span-2 space-y-6">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">Input Parameters</h2>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

                    <div class="input-group">
                        <label for="grade" class="block text-sm text-gray-700 mb-1">Concrete Grade ($f_{ck}$)</label>
                        <input type="number" id="grade" value="40" min="10" step="5" class="input-field" onchange="calculateMix()">
                        <p class="text-xs text-gray-500 mt-1">Required characteristic compressive strength at 28 days (MPa).</p>
                        <p id="grade_warning" class="text-xs text-red-600 mt-1 font-semibold hidden"></p>
                    </div>
                    
                    <div class="input-group">
                        <label for="cement_type" class="block text-sm text-gray-700 mb-1">Type of Cement & Grade (IS Code)</label>
                        <select id="cement_type" class="input-field bg-white" onchange="calculateMix()">
                            <option value="OPC53">OPC 53 Grade (IS 12269)</option>
                            <option value="OPC43">OPC 43 Grade (IS 8112)</option>
                            <option value="OPC33">OPC 33 Grade (IS 269)</option>
                            <option value="PPC" selected>Portland Pozzolana Cement (PPC) (IS 1489)</option>
                            <option value="PSC">Portland Slag Cement (PSC) (IS 455)</option>
                            <option value="Other">Other</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Used for durability and minimum cement content checks (IS 456).</p>
                    </div>

                    <div class="input-group">
                        <label for="exposure" class="block text-sm text-gray-700 mb-1">Exposure Condition (IS 456, Table 3)</label>
                        <select id="exposure" class="input-field bg-white" onchange="calculateMix()">
                            <option value="Mild">Mild</option>
                            <option value="Moderate">Moderate</option>
                            <option value="Severe" selected>Severe</option>
                            <option value="VerySevere">Very Severe</option>
                            <option value="Extreme">Extreme</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Affects minimum cement and maximum W/C ratio for durability.</p>
                    </div>
                    
                    <div class="input-group">
                        <label for="site_control" class="block text-sm text-gray-700 mb-1">Degree of Site Control</label>
                        <select id="site_control" class="input-field bg-white" onchange="calculateMix()">
                            <option value="Good" selected>Good</option>
                            <option value="Fair">Fair</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Influences standard deviation ($S$) for target strength. (Currently using conservative $S$).</p>
                    </div>
                    
                    <div class="input-group">
                        <label for="w_c_ratio_input" class="block text-sm text-gray-700 mb-1">Design Water-Cement Ratio (W/C)</label>
                        <input type="number" id="w_c_ratio_input" value="0.40" step="0.01" min="0.30" max="0.60" class="input-field" onchange="calculateMix()">
                        <p class="text-xs text-gray-500 mt-1">W/C Ratio chosen for strength calculation ($f'_{ck}$).</p>
                        <p id="wc_ratio_warning" class="text-xs text-red-600 mt-1 font-semibold hidden"></p>
                    </div>
                    
                    <div class="input-group">
                        <label for="max_cement_content" class="block text-sm text-gray-700 mb-1">Max Cement Content (Exc. Fly Ash/SCMs) (kg/m³)</label>
                        <input type="number" id="max_cement_content" value="450" min="300" step="10" class="input-field" onchange="calculateMix()">
                        <p class="text-xs text-gray-500 mt-1">Used as a hard limit (usually 450 kg/m³) to control creep/shrinkage/thermal cracking.</p>
                        <p id="max_cement_warning" class="text-xs text-red-600 mt-1 font-semibold hidden"></p>
                    </div>

                    <div class="input-group">
                        <label for="msa" class="block text-sm text-gray-700 mb-1">Max Aggregate Size (MSA)</label>
                        <select id="msa" class="input-field bg-white" onchange="calculateMix()">
                            <option value="20" selected>20 mm</option>
                            <option value="40">40 mm</option>
                            <option value="10">10 mm</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Determines initial water content.</p>
                    </div>
                    
                    <div class="input-group">
                        <label for="aggregate_type" class="block text-sm text-gray-700 mb-1">Type of Aggregate</label>
                        <select id="aggregate_type" class="input-field bg-white" onchange="calculateMix()">
                            <option value="CrushedAngular" selected>Crushed Angular Aggregate</option>
                            <option value="SubAngular">Sub-angular Aggregate</option>
                            <option value="Rounded">Rounded Aggregate</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Affects water demand (up to $\pm$ 20 kg/m³ correction from base table).</p>
                    </div>

                    <div class="input-group">
                        <label for="placing_method" class="block text-sm text-gray-700 mb-1">Method of Placing</label>
                        <select id="placing_method" class="input-field bg-white" onchange="calculateMix()">
                            <option value="NonPumpable" selected>Non-Pumpable (Conventional)</option>
                            <option value="Pumpable">Pumpable</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Affects workability (slump) requirement and max aggregate size recommendations.</p>
                    </div>
                    
                    <div class="input-group">
                        <label for="slump" class="block text-sm text-gray-700 mb-1">Required Slump/Workability (mm)</label>
                        <input type="number" id="slump" value="75" min="25" class="input-field" onchange="calculateMix()">
                        <p class="text-xs text-gray-500 mt-1">Typically 75-100 mm for Pumping/Heavy reinforcement.</p>
                    </div>

                    <div class="input-group">
                        <label for="admixture_type" class="block text-sm text-gray-700 mb-1">Chemical Admixture Type</label>
                        <select id="admixture_type" class="input-field bg-white" onchange="calculateMix()">
                            <option value="Superplasticizer" selected>Superplasticizer - Normal</option>
                            <option value="Retarder">Retarding Admixture</option>
                            <option value="Accelerator">Accelerating Admixture</option>
                            <option value="None">None</option>
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Used primarily to reduce water content for required workability.</p>
                    </div>

                    <div class="input-group">
                        <label for="sg_cement" class="block text-sm text-gray-700 mb-1">Specific Gravity of Cement</label>
                        <input type="number" id="sg_cement" value="2.88" step="0.01" class="input-field" onchange="calculateMix()">
                    </div>
                    <div class="input-group">
                        <label for="sg_fa" class="block text-sm text-gray-700 mb-1">Specific Gravity of Fine Aggregate (SSD)</label>
                        <input type="number" id="sg_fa" value="2.65" step="0.01" class="input-field" onchange="calculateMix()">
                    </div>
                    <div class="input-group">
                        <label for="sg_ca" class="block text-sm text-gray-700 mb-1">Specific Gravity of Coarse Aggregate (SSD)</label>
                        <input type="number" id="sg_ca" value="2.74" step="0.01" class="input-field" onchange="calculateMix()">
                    </div>
                    
                    <div class="input-group">
                        <label for="sg_admixture" class="block text-sm text-gray-700 mb-1">Specific Gravity of Chemical Admixture</label>
                        <input type="number" id="sg_admixture" value="1.145" step="0.001" class="input-field" onchange="calculateMix()">
                        <p class="text-xs text-gray-500 mt-1">Used for calculating the absolute volume of the liquid admixture.</p>
                    </div>

                    <div class="input-group">
                        <label for="admixture_percent" class="block text-sm text-gray-700 mb-1">Admixture Dosage (% by mass of cement)</label>
                        <input type="number" id="admixture_percent" value="1.0" step="0.01" class="input-field" onchange="calculateMix()">
                    </div>

                    <div class="input-group">
                        <label for="fa_moisture" class="block text-sm text-gray-700 mb-1">FA Free Surface Moisture (%)</label>
                        <input type="number" id="fa_moisture" value="0.0" step="0.1" class="input-field" onchange="calculateMix()">
                    </div>
                    <div class="input-group">
                        <label for="ca_moisture" class="block text-sm text-gray-700 mb-1">CA Free Surface Moisture (%)</label>
                        <input type="number" id="ca_moisture" value="0.0" step="0.1" class="input-field" onchange="calculateMix()">
                    </div>
                    <div class="input-group">
                        <label for="ca_absorption" class="block text-sm text-gray-700 mb-1">CA Water Absorption (%)</label>
                        <input type="number" id="ca_absorption" value="0.5" step="0.1" class="input-field" onchange="calculateMix()">
                    </div>
                    <div class="input-group">
                        <label for="fa_absorption" class="block text-sm text-gray-700 mb-1">FA Water Absorption (%)</label>
                        <input type="number" id="fa_absorption" value="1.0" step="0.1" class="input-field" onchange="calculateMix()">
                    </div>
                </div>

                <button onclick="calculateMix()" class="w-full mt-6 py-3 px-6 bg-emerald-500 text-white font-bold rounded-lg shadow-lg hover:bg-emerald-600 transition duration-150 transform hover:scale-[1.01]">
                    Calculate Mix Proportions
                </button>
            </section>

            <section class="lg:col-span-1">
                <h2 class="text-2xl font-semibold text-gray-700 border-b pb-2 mb-4">Results</h2>
                <div id="output-card" class="bg-gray-100 p-6 rounded-lg shadow-inner space-y-4">
                    
                    <h3 class="text-xl font-bold text-gray-800 border-b pb-2">IS 456 Durability Requirements</h3>
                    <p class="text-sm text-gray-600">Based on Exposure Condition (Reinforced Concrete).</p>
                    <ul class="space-y-1 bg-yellow-100 p-3 rounded-md">
                        <li>Min Grade (IS 456, Table 5): <span id="min_grade_req_display" class="font-mono font-bold text-red-600">N/A</span></li>
                        <li>Min Cement Content (IS 456, Table 5): <span id="min_cement_req" class="font-mono font-bold text-red-600">N/A</span> kg/m³</li>
                        <li>Max Water-Cement Ratio (IS 456, Table 5): <span id="max_wc_req" class="font-mono font-bold text-red-600">N/A</span></li>
                        <li class="mt-2 text-xs">W/C Ratio used for calculation (Governing): <span id="governing_wc" class="font-mono font-bold text-blue-600">N/A</span></li>
                    </ul>
                    <h3 class="text-xl font-bold text-gray-800 border-t pt-2 mt-4">Design Checks & Adjustments</h3>
                    <p id="placing_warning" class="text-xs text-orange-600 mt-1 font-semibold hidden bg-orange-100 p-2 rounded"></p>
                    <p id="cement_max_warning" class="text-xs text-orange-600 mt-1 font-semibold hidden bg-orange-100 p-2 rounded"></p>
                    
                    <p id="target-strength-display" class="font-medium text-lg text-green-700 border-t pt-4">Target Strength ($f'_{ck}$): N/A</p>
                    <p id="water_content_display" class="text-sm text-gray-700">Net Water Content Used: <span id="res_water_net" class="font-mono font-bold text-gray-800">N/A</span> kg/m³</p>


                    <div id="output-final-mix" class="space-y-2">
                        <h3 class="text-xl font-bold text-gray-800 border-t pt-2 mt-4">Required Quantities (SSD Mass)</h3>
                        <p class="text-sm">These quantities are based on Saturated Surface Dry (SSD) condition.</p>
                        <ul class="space-y-1">
                            <li>Cement: <span id="res_cement" class="font-mono bg-yellow-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Water (Net): <span id="res_water" class="font-mono bg-yellow-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Fine Aggregate (FA): <span id="res_fa" class="font-mono bg-yellow-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Coarse Aggregate (CA): <span id="res_ca" class="font-mono bg-yellow-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Admixture: <span id="res_admixture" class="font-mono bg-yellow-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                        </ul>

                        <h3 class="text-xl font-bold text-gray-800 border-t pt-2 mt-4">Field Quantities (with Moisture Correction)</h3>
                        <p class="text-sm">These are the masses to be batched considering moisture content in aggregates.</p>
                        <ul class="space-y-1">
                            <li>Cement: <span id="field_cement" class="font-mono bg-blue-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Water (Adjusted): <span id="field_water" class="font-mono bg-blue-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Fine Aggregate (FA Wet): <span id="field_fa" class="font-mono bg-blue-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                            <li>Coarse Aggregate (CA Wet): <span id="field_ca" class="font-mono bg-blue-200 px-2 py-0.5 rounded">0.0</span> kg/m³</li>
                        </ul>
                        
                        <h3 class="text-xl font-bold text-gray-800 border-t pt-2 mt-4">Detailed Design Calculations</h3>
                        <div id="detailed-calculations" class="space-y-3">
                            <p class="text-gray-500">Run calculation to see detailed steps...</p>
                        </div>
                    </div>
                </div>
                <div id="error-message" class="mt-4 p-4 bg-red-100 text-red-700 border border-red-400 rounded-lg hidden"></div>
            </section>
        </main>
    </div>

    <script>
        // IS 10262:2019 Lookup Tables (Simplified)

        // Standard Deviation (S) lookup based on Concrete Grade (IS 456 Table 8)
        const STANDARD_DEVIATION = {
            '10': 3.5, // M10, M15
            '15': 3.5,
            '20': 4.0, // M20, M25
            '25': 4.0,
            // M30 and above (M30-M50) are 5.0 MPa
            '30': 5.0,
            '35': 5.0,
            '40': 5.0,
            '45': 5.0,
            '50': 5.0,
        };

        // Approximate Water Content (kg/m³) for 25-50mm Slump (Table 4, IS 10262:2019)
        const INITIAL_WATER_CONTENT = {
            '10': 208,
            '20': 186,
            '40': 165,
        };

        // Water Content Correction based on Aggregate Type (IS 10262:2019 Clause 4.2.2.1)
        const AGGREGATE_WATER_CORRECTION = {
            'Rounded': -25, // For rounded aggregate, reduce water by 25 kg/m³
            'SubAngular': -10, // For sub-angular aggregate, reduce water by 10 kg/m³
            'CrushedAngular': 0, // Crushed angular is the base for Table 4 (0 correction)
        };

        // Volume of Coarse Aggregate (CA) per unit volume of total aggregate for different W/C ratios (Table 5, IS 10262:2019)
        // Values for Zone II Fine Aggregate (a common assumption)
        const CA_VOLUME_FRACTION = {
            '20': { 0.3: 0.66, 0.35: 0.64, 0.4: 0.62, 0.45: 0.60, 0.5: 0.59, 0.55: 0.58, 0.6: 0.57 },
            '40': { 0.3: 0.75, 0.35: 0.73, 0.4: 0.71, 0.45: 0.69, 0.5: 0.68, 0.55: 0.67, 0.6: 0.66 },
            '10': { 0.3: 0.53, 0.35: 0.51, 0.4: 0.49, 0.45: 0.47, 0.5: 0.46, 0.55: 0.45, 0.6: 0.44 },
        };

        // Durability Requirements (IS 456:2000, Table 5, Reinforced Concrete, based on Exposure)
        const IS_456_DURABILITY_LIMITS = {
            'Mild': { min_cement: 300, max_wc: 0.50, min_grade: 20 },
            'Moderate': { min_cement: 310, max_wc: 0.45, min_grade: 25 },
            'Severe': { min_cement: 320, max_wc: 0.45, min_grade: 30 },
            'VerySevere': { min_cement: 330, max_wc: 0.45, min_grade: 35 },
            'Extreme': { min_cement: 340, max_wc: 0.40, min_grade: 40 }
        };

        // Utility function to round to specific decimal places
        const round = (num, dp = 2) => Math.round(num * (10 ** dp)) / (10 ** dp);

        function displayError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = `ERROR: ${message}`;
            errorElement.classList.remove('hidden');
        }

        function clearError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function calculateMix() {
            clearError();
            
            // 1. Get Inputs
            const fck = parseInt(document.getElementById('grade').value); // Characteristic Strength (MPa)
            const exposure = document.getElementById('exposure').value; // Exposure Condition (e.g., Severe)
            // const cementType = document.getElementById('cement_type').value; // Cement Type
            const msa = parseInt(document.getElementById('msa').value); // Max Nominal Aggregate Size (mm)
            const requiredSlump = parseFloat(document.getElementById('slump').value); // Slump (mm)
            const wCRatioDesign = parseFloat(document.getElementById('w_c_ratio_input').value); // Target W/C Ratio (Design)
            const S_cement = parseFloat(document.getElementById('sg_cement').value); // Specific Gravity Cement
            const S_fa = parseFloat(document.getElementById('sg_fa').value); // Specific Gravity Fine Aggregate (SSD)
            const S_ca = parseFloat(document.getElementById('sg_ca').value); // Specific Gravity Coarse Aggregate (SSD)
            const S_admixture = parseFloat(document.getElementById('sg_admixture').value); // Specific Gravity Chemical Admixture (NEW)
            const admixturePercent = parseFloat(document.getElementById('admixture_percent').value) / 100; // Admixture %
            const faMoisture = parseFloat(document.getElementById('fa_moisture').value) / 100; // FA Free Surface Moisture
            const caMoisture = parseFloat(document.getElementById('ca_moisture').value) / 100; // CA Free Surface Moisture
            const caAbsorption = parseFloat(document.getElementById('ca_absorption').value) / 100; // CA Water Absorption
            const faAbsorption = parseFloat(document.getElementById('fa_absorption').value) / 100; // FA Water Absorption
            const placingMethod = document.getElementById('placing_method').value; // Placing Method (Pumpable/Non-Pumpable)
            const aggregateType = document.getElementById('aggregate_type').value; // Type of Aggregate (Crushed Angular, Rounded)
            const maxCementLimit = parseFloat(document.getElementById('max_cement_content').value); // Max Cement Content Limit

            // Input Validation (Basic)
            if (isNaN(fck) || fck < 10 || isNaN(msa) || isNaN(wCRatioDesign) || isNaN(S_cement) || isNaN(S_fa) || isNaN(S_ca) || isNaN(S_admixture) || wCRatioDesign <= 0 || S_cement <= 0 || S_fa <= 0 || S_ca <= 0 || S_admixture <= 0) {
                return displayError("Please ensure the concrete grade is M10 or higher and all primary input fields, including Specific Gravities, have valid positive numbers.");
            }
            if (!IS_456_DURABILITY_LIMITS[exposure]) {
                return displayError(`Unknown exposure condition: ${exposure}`);
            }

            // Reset Warnings
            const wcWarningElement = document.getElementById('wc_ratio_warning');
            const gradeWarningElement = document.getElementById('grade_warning');
            const placingWarningElement = document.getElementById('placing_warning');
            const maxCementWarningElement = document.getElementById('max_cement_warning');

            [wcWarningElement, gradeWarningElement, placingWarningElement, maxCementWarningElement].forEach(el => {
                el.classList.add('hidden');
                el.textContent = '';
            });

            // Variable to build detailed calculations HTML
            let calcDetails = '';


            // --- DURABILITY CHECK (IS 456, Table 5) ---
            const durabilityLimits = IS_456_DURABILITY_LIMITS[exposure];
            const min_cement_req = durabilityLimits.min_cement;
            const max_wc_req = durabilityLimits.max_wc;
            const min_grade_req = durabilityLimits.min_grade;
            
            // Display Durability Limits in Output
            document.getElementById('min_grade_req_display').textContent = `M${min_grade_req}`;
            document.getElementById('min_cement_req').textContent = min_cement_req;
            document.getElementById('max_wc_req').textContent = max_wc_req.toFixed(2);

            let wc_check_message = '';
            // --- W/C RATIO CODE COMPLIANCE CHECK ---
            let wCRatioGoverning = wCRatioDesign;
            if (wCRatioDesign > max_wc_req) {
                const warningMessage = `Input W/C Ratio (${wCRatioDesign.toFixed(2)}) exceeds the maximum permitted W/C Ratio (${max_wc_req.toFixed(2)}) for ${exposure} exposure (IS 456, Table 5). The calculation proceeds using the code-compliant limit of ${max_wc_req.toFixed(2)}.`;
                wcWarningElement.textContent = warningMessage;
                wcWarningElement.classList.remove('hidden');
                
                wCRatioGoverning = max_wc_req;
                wc_check_message = `(Design W/C ${wCRatioDesign.toFixed(2)} > Max W/C ${max_wc_req.toFixed(2)}). Max W/C is adopted.`;
            } else {
                wCRatioGoverning = Math.min(wCRatioDesign, max_wc_req);
                wc_check_message = `(Design W/C ${wCRatioDesign.toFixed(2)} is less than Max W/C ${max_wc_req.toFixed(2)}). Design W/C is adopted.`;
            }
            document.getElementById('governing_wc').textContent = wCRatioGoverning.toFixed(3);


            // --- STEP 1: Target Mean Strength ($f'_{ck}$) ---
            let S = STANDARD_DEVIATION[fck.toString()];
            if (!S) { S = (fck >= 30) ? 5.0 : 4.0; }
            const fck_target = fck + (1.65 * S);
            document.getElementById('target-strength-display').textContent = `Target Strength ($f'_{ck}$): ${round(fck_target)} MPa`;

            calcDetails += `<div class="calculation-step">
                <h4>1. Target Mean Strength ($f'_{ck}$)</h4>
                <p>Formula: $f'_{ck} = f_{ck} + 1.65 \\times S$</p>
                <p>Where $f_{ck} = ${fck} \text{ MPa}$ and $S = ${S} \text{ MPa}$ (Standard Deviation for M${fck}$).</p>
                <p>Calculation: $40 + 1.65 \\times ${S} = \\mathbf{${round(fck_target).toFixed(2)}} \text{ MPa}$</p>
            </div>`;


            // --- STEP 2: Determine Water Content and Cement Content ---
            
            calcDetails += `<div class="calculation-step">
                <h4>2. Determination of Cement Content</h4>
                
                <p>Initial Water (from IS 10262 Table 4 for ${msa}mm MSA, 25-50mm slump): <span class="res">${INITIAL_WATER_CONTENT[msa.toString()]} \text{ kg/m}^3$</span></p>
                <p>Correction for ${aggregateType}: ${AGGREGATE_WATER_CORRECTION[aggregateType]} \text{ kg/m}^3$</p>`;
            
            const water_content_initial = INITIAL_WATER_CONTENT[msa.toString()];
            const agg_correction = AGGREGATE_WATER_CORRECTION[aggregateType] || 0;
            let water_content_base = water_content_initial + agg_correction;
            
            calcDetails += `<p>Base Water Content ($\text{W}_{base}$): ${water_content_initial} + ${agg_correction} = <span class="res">${water_content_base.toFixed(2)} \text{ kg/m}^3$</span></p>`;

            // Slump Correction
            const slump_base_calc = 50; 
            const slump_difference = requiredSlump - slump_base_calc;
            const slump_correction_factor = 1 + (slump_difference / 25) * 0.03;
            let water_content_slump = water_content_base * slump_correction_factor;

            calcDetails += `<p>Slump Correction (3% per 25mm $\Delta$ Slump): Factor $1 + ((${requiredSlump} - 50)/25) \\times 0.03 = ${round(slump_correction_factor, 3)} \text{ (Factor)}$</p>
                            <p>Water Content after Slump Correction: ${water_content_base.toFixed(2)} \\times ${round(slump_correction_factor, 3)} = <span class="res">${water_content_slump.toFixed(2)} \text{ kg/m}^3$</span></p>`;

            // Admixture Reduction
            let water_reduction_percent = 0;
            let water_content_net = water_content_slump;
            if (admixturePercent > 0) {
                 water_reduction_percent = 0.05 + Math.min(admixturePercent, 2.0) * 0.05; 
                 water_content_net = water_content_slump * (1 - water_reduction_percent);
                 calcDetails += `<p>Admixture Water Reduction (approx. 5% + 5% per 1% dosage): ${round(water_reduction_percent * 100, 2)} \text{ \%}$</p>
                                 <p>Water Content ($\text{W}_{net}$) after Admixture: ${water_content_slump.toFixed(2)} \\times (1 - ${round(water_reduction_percent, 4)}) = <span class="res">${round(water_content_net).toFixed(1)} \text{ kg/m}^3$</span></p>`;
            } else {
                 calcDetails += `<p>Admixture Reduction: $0\%$. $\text{W}_{net} = ${round(water_content_net).toFixed(1)} \text{ kg/m}^3$</p>`;
            }


            // Cement Content
            let cement_content = water_content_net / wCRatioGoverning;
            let final_cement_content = cement_content;
            let cement_check_message = '';

            calcDetails += `<p>Governing W/C Ratio ($\text{WCR}_{gov}$): <span class="res">${wCRatioGoverning.toFixed(3)}</span> ${wc_check_message}</p>
                            <p>Initial Cement Content ($C_{initial} = \text{W}_{net} / \text{WCR}_{gov}$): ${round(water_content_net).toFixed(1)} / ${wCRatioGoverning.toFixed(3)} = <span class="res">${round(cement_content).toFixed(1)} \text{ kg/m}^3$</span></p>`;

            // Check Minimum Cement
            if (final_cement_content < min_cement_req) {
                final_cement_content = min_cement_req;
                cement_check_message += `Initial $C$ (${round(cement_content).toFixed(1)}$) is less than Min $C$ (${min_cement_req}$). Min $C$ is adopted.`;
            }

            // Check Maximum Cement
            if (final_cement_content > maxCementLimit) {
                maxCementWarningElement.textContent = `WARNING: Calculated Cement Content (${round(final_cement_content).toFixed(1)} kg/m³) exceeds the specified Maximum Limit (${maxCementLimit} kg/m³). Using Max Limit for calculation.`;
                maxCementWarningElement.classList.remove('hidden');
                final_cement_content = maxCementLimit;
                cement_check_message += `Calculated $C$ (${round(cement_content).toFixed(1)}$) exceeds Max $C$ (${maxCementLimit}$). Max $C$ is adopted.`;
            }

            // Recalculate W_net if cement was capped
            let final_water_content = water_content_net;
            if (final_cement_content !== cement_content) {
                // If cement was adjusted by a limit, water must be recalculated to maintain W/C = 0.40
                final_water_content = final_cement_content * wCRatioGoverning;
            }

            const admixture_content = final_cement_content * admixturePercent;

            calcDetails += `<p>Cement Content Check: ${cement_check_message}</p>
                            <p><strong>Final Cement Content (C):</strong> <span class="res">${round(final_cement_content).toFixed(1)} \text{ kg/m}^3$</span></p>
                            <p><strong>Final Net Water ($\text{W}_{net}$):</strong> ${round(final_cement_content).toFixed(1)} \\times ${wCRatioGoverning.toFixed(3)} = <span class="res">${round(final_water_content).toFixed(1)} \text{ kg/m}^3$</span></p>
                            <p><strong>Admixture Content (Ad):</strong> ${round(final_cement_content).toFixed(1)} \\times ${round(admixturePercent, 4)} = <span class="res">${round(admixture_content).toFixed(3)} \text{ kg/m}^3$</span></p>
            </div>`;


            // --- STEP 3: Aggregate Volumes (Absolute Volume Method) ---
            
            const V_c = (final_cement_content / S_cement) * (1 / 1000);
            const V_w = (final_water_content / 1.0) * (1 / 1000); 
            const V_ad = (admixture_content / S_admixture) * (1 / 1000);
            const V_non_agg = V_c + V_w + V_ad;
            const V_agg = 1.0 - V_non_agg;

            calcDetails += `<div class="calculation-step">
                <h4>3. Absolute Volume Calculation (SSD)</h4>
                <p>Volume (V) = Mass / (SG \\times 1000)</p>
                <p> $V_c$: ${round(final_cement_content).toFixed(1)} / (${S_cement} \\times 1000) = <span class="res">${round(V_c, 5).toFixed(5)} \text{ m}^3$</span></p>
                <p> $V_w$: ${round(final_water_content).toFixed(1)} / (1.00 \\times 1000) = <span class="res">${round(V_w, 5).toFixed(5)} \text{ m}^3$</span></p>
                <p> $V_{ad}$: ${round(admixture_content).toFixed(3)} / (${S_admixture} \\times 1000) = <span class="res">${round(V_ad, 5).toFixed(5)} \text{ m}^3$</span></p>
                <p> $V_{non\_agg}$: ${round(V_c, 5).toFixed(5)} + ${round(V_w, 5).toFixed(5)} + ${round(V_ad, 5).toFixed(5)} = <span class="res">${round(V_non_agg, 5).toFixed(5)} \text{ m}^3$</span></p>
                <p><strong>Total Aggregate Volume ($\mathbf{V_{agg}}$):</strong> $1.0 - V_{non\_agg} = \\mathbf{${round(V_agg, 5).toFixed(5)} \text{ m}^3$}</p>
            </div>`;
            
            if (V_agg <= 0) {
                 return displayError("Volume of aggregates is zero or negative. Check your inputs (e.g., low SG, high cement/water).");
            }


            // --- STEP 4: Determine Volume Fractions of Aggregates ---
            const CA_FRACTION_MAP = CA_VOLUME_FRACTION[msa.toString()];
            const keys = Object.keys(CA_FRACTION_MAP).map(Number).sort((a, b) => a - b);
            let Vca_Vt_ratio; 

            if (wCRatioGoverning <= keys[0]) {
                Vca_Vt_ratio = CA_FRACTION_MAP[keys[0]];
            } else if (wCRatioGoverning >= keys[keys.length - 1]) {
                Vca_Vt_ratio = CA_FRACTION_MAP[keys[keys.length - 1]];
            } else {
                for (let i = 0; i < keys.length - 1; i++) {
                    const k1 = keys[i];
                    const k2 = keys[i+1];
                    if (wCRatioGoverning >= k1 && wCRatioGoverning <= k2) {
                        // Linear interpolation
                        const b1 = CA_FRACTION_MAP[k1];
                        const b2 = CA_FRACTION_MAP[k2];
                        Vca_Vt_ratio = b1 + (b2 - b1) * ((wCRatioGoverning - k1) / (k2 - k1));
                        break;
                    }
                }
            }

            const V_ca = V_agg * Vca_Vt_ratio;
            const V_fa = V_agg - V_ca;

            calcDetails += `<div class="calculation-step">
                <h4>4. Individual Aggregate Volumes and SSD Mass</h4>
                <p>Volume of CA to Total Aggregate ($\mathbf{V_{ca}/V_{t}}$) from IS 10262 Table 5 (MSA ${msa}mm, W/C ${wCRatioGoverning.toFixed(2)}$): <span class="res">${round(Vca_Vt_ratio, 3).toFixed(3)}</span></p>
                <p>Volume of CA ($V_{ca}$): $V_{agg} \\times V_{ca}/V_{t} = ${round(V_agg, 5).toFixed(5)} \\times ${round(Vca_Vt_ratio, 3).toFixed(3)} = <span class="res">${round(V_ca, 5).toFixed(5)} \text{ m}^3$</span></p>
                <p>Volume of FA ($V_{fa}$): $V_{agg} - V_{ca} = ${round(V_agg, 5).toFixed(5)} - ${round(V_ca, 5).toFixed(5)} = <span class="res">${round(V_fa, 5).toFixed(5)} \text{ m}^3$</span></p>
            </div>`;

            // --- STEP 5: Calculate SSD Masses (kg/m³) ---
            const CA_mass_ssd = V_ca * S_ca * 1000;
            const FA_mass_ssd = V_fa * S_fa * 1000;
            
            calcDetails += `<div class="calculation-step">
                <h4>5. Required SSD Masses</h4>
                <p>Mass = Volume \\times SG \\times 1000</p>
                <p><strong>Coarse Aggregate ($M_{ca}$ SSD):</strong> ${round(V_ca, 5).toFixed(5)} \\times ${S_ca} \\times 1000 = <span class="res">${round(CA_mass_ssd).toFixed(1)} \text{ kg/m}^3$</span></p>
                <p><strong>Fine Aggregate ($M_{fa}$ SSD):</strong> ${round(V_fa, 5).toFixed(5)} \\times ${S_fa} \\times 1000 = <span class="res">${round(FA_mass_ssd).toFixed(1)} \text{ kg/m}^3$</span></p>
            </div>`;


            // --- STEP 6: Moisture Correction (Field Quantities) ---
            const fa_water_correction_needed = (faAbsorption - faMoisture) * FA_mass_ssd; // Water needed by FA (negative if FSM > WA)
            const ca_water_correction_needed = (caAbsorption - caMoisture) * CA_mass_ssd; // Water needed by CA

            const total_water_correction = -(fa_water_correction_needed + ca_water_correction_needed); // Total water correction to apply to batched water

            const water_mass_adjusted = final_water_content + total_water_correction;
            
            // Field aggregate masses are the SSD mass plus the FSM
            const CA_mass_field = CA_mass_ssd * (1 + caMoisture);
            const FA_mass_field = FA_mass_ssd * (1 + faMoisture);

            const fa_correction_kg = faMoisture * FA_mass_ssd;
            const ca_correction_kg = caMoisture * CA_mass_ssd;
            
            calcDetails += `<div class="calculation-step">
                <h4>6. Moisture Correction and Field Quantities</h4>
                <p>Water Absorption (WA): CA ${caAbsorption*100}\%, FA ${faAbsorption*100}\%</p>
                <p>Free Surface Moisture (FSM): CA ${caMoisture*100}\%, FA ${faMoisture*100}\%</p>
                <p>Water in FA (FSM): ${round(FA_mass_ssd).toFixed(1)} \\times ${faMoisture.toFixed(3)} = ${round(fa_correction_kg).toFixed(2)} \text{ kg}$</p>
                <p>Water in CA (FSM): ${round(CA_mass_ssd).toFixed(1)} \\times ${caMoisture.toFixed(3)} = ${round(ca_correction_kg).toFixed(2)} \text{ kg}$</p>
                
                <p>Total Water Correction ($\Delta W$): $-((\text{FSM}_{fa} - \text{WA}_{fa})M_{fa} + (\text{FSM}_{ca} - \text{WA}_{ca})M_{ca})$</p>
                <p>Calculation: $-((${faMoisture.toFixed(3)} - ${faAbsorption.toFixed(3)}) \times ${round(FA_mass_ssd).toFixed(1)} + (${caMoisture.toFixed(3)} - ${caAbsorption.toFixed(3)}) \times ${round(CA_mass_ssd).toFixed(1)})$</p>
                <p> $\Delta W$: <span class="res">${round(total_water_correction).toFixed(2)} \text{ kg}$</span></p>
                
                <p><strong>Batched Water ($W_{field}$):</strong> $W_{net} + \Delta W = ${round(final_water_content).toFixed(1)} + ${round(total_water_correction).toFixed(2)} = <span class="res">${round(water_mass_adjusted).toFixed(1)} \text{ kg/m}^3$</span></p>
                <p><strong>Batched FA Mass ($\mathbf{M_{fa}}$ Wet):</strong> ${round(FA_mass_ssd).toFixed(1)} \\times (1 + ${faMoisture.toFixed(3)}) = <span class="res">${round(FA_mass_field).toFixed(1)} \text{ kg/m}^3$</span></p>
                <p><strong>Batched CA Mass ($\mathbf{M_{ca}}$ Wet):</strong> ${round(CA_mass_ssd).toFixed(1)} \\times (1 + ${caMoisture.toFixed(3)}) = <span class="res">${round(CA_mass_field).toFixed(1)} \text{ kg/m}^3$</span></p>
            </div>`;


            // --- STEP 7: Display Results ---

            // Display SSD Results
            document.getElementById('res_cement').textContent = round(final_cement_content).toFixed(1);
            document.getElementById('res_water').textContent = round(final_water_content).toFixed(1);
            document.getElementById('res_fa').textContent = round(FA_mass_ssd).toFixed(1);
            document.getElementById('res_ca').textContent = round(CA_mass_ssd).toFixed(1);
            document.getElementById('res_admixture').textContent = round(admixture_content).toFixed(3);

            // Display Field (Corrected) Results
            document.getElementById('field_cement').textContent = round(final_cement_content).toFixed(1); // Cement is batched dry
            document.getElementById('field_water').textContent = round(Math.max(0, water_mass_adjusted)).toFixed(1);
            document.getElementById('field_fa').textContent = round(FA_mass_field).toFixed(1);
            document.getElementById('field_ca').textContent = round(CA_mass_field).toFixed(1);
            document.getElementById('res_water_net').textContent = round(final_water_content).toFixed(1);

            // Mix Ratio
            const ratio_fa = FA_mass_ssd / final_cement_content;
            const ratio_ca = CA_mass_ssd / final_cement_content;
            const mix_ratio_text = `Mix Ratio (C:FA:CA) approx 1 : ${round(ratio_fa).toFixed(2)} : ${round(ratio_ca).toFixed(2)}`;
            let ratioElement = document.getElementById('output-final-mix').querySelector('.mix-ratio');
            if (!ratioElement) {
                const p = document.createElement('p');
                p.className = 'mix-ratio font-semibold text-gray-700 mt-2';
                ratioElement = document.getElementById('output-final-mix').appendChild(p);
            }
            ratioElement.textContent = mix_ratio_text;

            // Inject detailed calculations
            document.getElementById('detailed-calculations').innerHTML = calcDetails;
        }

        // Run calculation on load with default values
        window.onload = calculateMix;

    </script>
</body>
</html>
